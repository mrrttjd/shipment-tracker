<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .form-container {
            margin-bottom: 30px;
        }
        .results-container {
            margin-top: 20px;
        }
        .shipment-card {
            margin-bottom: 20px;
            border-left: 5px solid #0d6efd;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .loading {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .api-error {
            display: none;
            margin-top: 20px;
        }
        .tracking-history {
            margin-top: 25px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-center">Shipment Tracker</h1>
            <p class="text-center text-muted">Track your shipments with ease</p>
        </div>

        <div class="form-container">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Enter Tracking Information</h5>
                    <form id="trackingForm">
                        <div class="mb-3">
                            <label for="trackingType" class="form-label">Select tracking type:</label>
                            <select class="form-select" id="trackingType" required>
                                <option value="transportDocumentReference">Transport Document Number</option>
                                <option value="carrierBookingReference">Booking Reference</option>
                                <option value="equipmentReference">Container Number</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="trackingNumber" class="form-label">Tracking Number:</label>
                            <input type="text" class="form-control" id="trackingNumber" placeholder="Enter tracking number" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Track Shipment</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Fetching shipment information...</p>
        </div>

        <div class="api-error alert alert-danger">
            <h5>Error Tracking Shipment</h5>
            <p id="errorMessage"></p>
        </div>

        <div class="results-container">
            <div id="trackingResults"></div>
        </div>

        <div class="tracking-history">
            <h4>Tracking History</h4>
            <p class="text-muted">Recent tracking numbers you've searched</p>
            <div class="table-responsive">
                <table class="table table-striped" id="historyTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Tracking Number</th>
                            <th>Date Searched</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History items will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const trackingForm = document.getElementById('trackingForm');
            const trackingResults = document.getElementById('trackingResults');
            const historyTableBody = document.getElementById('historyTableBody');
            const loadingIndicator = document.querySelector('.loading');
            const apiError = document.querySelector('.api-error');
            const errorMessage = document.getElementById('errorMessage');
            
            // Load tracking history from localStorage
            loadTrackingHistory();
            
            trackingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const trackingType = document.getElementById('trackingType').value;
                const trackingNumber = document.getElementById('trackingNumber').value.trim();
                
                if (!trackingNumber) {
                    alert('Please enter a tracking number');
                    return;
                }
                
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                // Hide any previous errors
                apiError.style.display = 'none';
                
                // Call the tracking API
                trackShipment(trackingType, trackingNumber);
                
                // Save to tracking history
                saveToTrackingHistory(trackingType, trackingNumber);
            });
            
            function trackShipment(trackingType, trackingNumber) {
                // In a real implementation, you would need to use your API credentials
                const clientId = 'YOUR_CLIENT_ID';  // Replace with your actual client ID
                const clientSecret = 'YOUR_CLIENT_SECRET';  // Replace with your actual client secret
                
                // Base URL for the API
                const baseUrl = 'https://api.hlag.com/hlag/external/v2/events';
                
                // Create API URL with the tracking parameters
                const apiUrl = `${baseUrl}?${trackingType}=${encodeURIComponent(trackingNumber)}`;
                
                // For demonstration purposes, we'll simulate an API response
                // In a real implementation, you would use fetch() to call the API
                simulateApiCall(trackingType, trackingNumber)
                    .then(data => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        // Display the results
                        displayResults(data, trackingType, trackingNumber);
                    })
                    .catch(error => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        // Show error message
                        errorMessage.textContent = error.message || 'Error fetching shipment data. Please try again.';
                        apiError.style.display = 'block';
                    });
                
                // Commented out real API call - would replace the simulateApiCall above
                /*
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'X-IBM-Client-Id': clientId,
                        'X-IBM-Client-Secret': clientSecret,
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Display the results
                    displayResults(data, trackingType, trackingNumber);
                })
                .catch(error => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Show error message
                    errorMessage.textContent = error.message || 'Error fetching shipment data. Please try again.';
                    apiError.style.display = 'block';
                });
                */
            }
            
            function displayResults(data, trackingType, trackingNumber) {
                // Clear previous results
                trackingResults.innerHTML = '';
                
                if (data.length === 0) {
                    trackingResults.innerHTML = `
                        <div class="alert alert-warning">
                            No tracking information found for ${getTrackingTypeLabel(trackingType)}: ${trackingNumber}
                        </div>
                    `;
                    return;
                }
                
                // Create header for the results
                const headerHtml = `
                    <h3>Tracking Results for ${getTrackingTypeLabel(trackingType)}: ${trackingNumber}</h3>
                    <p class="text-muted">Found ${data.length} events</p>
                `;
                
                // Create the table
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Event Type</th>
                                    <th>Event Date</th>
                                    <th>Location</th>
                                    <th>Vessel/Voyage</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort events by date (newest first)
                data.sort((a, b) => new Date(b.eventDateTime) - new Date(a.eventDateTime));
                
                // Add each event to the table
                data.forEach(event => {
                    const eventType = event.eventType;
                    const eventDate = formatDate(event.eventDateTime);
                    
                    let location = 'N/A';
                    let vesselVoyage = 'N/A';
                    let status = 'N/A';
                    let details = '';
                    
                    if (eventType === 'TRANSPORT') {
                        location = event.transportCall?.UNLocationCode || 'N/A';
                        status = event.transportEventTypeCode || 'N/A';
                        
                        if (event.transportCall?.vessel) {
                            vesselVoyage = `${event.transportCall.vessel.vesselName || 'Unknown'} / ${event.transportCall.exportVoyageNumber || 'N/A'}`;
                        }
                        
                        details = `Mode: ${event.transportCall?.modeOfTransport || 'N/A'}`;
                    } else if (eventType === 'EQUIPMENT') {
                        location = event.eventLocation?.UNLocationCode || 'N/A';
                        status = event.equipmentEventTypeCode || 'N/A';
                        details = `Empty: ${event.emptyIndicatorCode || 'N/A'}, Equipment: ${event.equipmentReference || 'N/A'}`;
                    } else if (eventType === 'SHIPMENT') {
                        status = event.shipmentEventTypeCode || 'N/A';
                        details = `Document: ${event.documentTypeCode || 'N/A'}, ID: ${event.documentID || 'N/A'}`;
                    }
                    
                    tableHtml += `
                        <tr>
                            <td>${eventType}</td>
                            <td>${eventDate}</td>
                            <td>${location}</td>
                            <td>${vesselVoyage}</td>
                            <td><span class="badge bg-primary">${status}</span></td>
                            <td>${details}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add the header and table to the results div
                trackingResults.innerHTML = headerHtml + tableHtml;
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString();
            }
            
            function getTrackingTypeLabel(trackingType) {
                switch(trackingType) {
                    case 'transportDocumentReference':
                        return 'Transport Document';
                    case 'carrierBookingReference':
                        return 'Booking Reference';
                    case 'equipmentReference':
                        return 'Container Number';
                    default:
                        return trackingType;
                }
            }
            
            function saveToTrackingHistory(trackingType, trackingNumber) {
                const historyItem = {
                    type: trackingType,
                    number: trackingNumber,
                    date: new Date().toISOString()
                };
                
                // Get existing history from localStorage
                let history = JSON.parse(localStorage.getItem('trackingHistory') || '[]');
                
                // Check if this item already exists in history
                const existingItemIndex = history.findIndex(item => 
                    item.type === trackingType && item.number === trackingNumber
                );
                
                // If exists, remove it (we'll add it back at the top)
                if (existingItemIndex !== -1) {
                    history.splice(existingItemIndex, 1);
                }
                
                // Add new item at the beginning
                history.unshift(historyItem);
                
                // Keep only the last 10 items
                history = history.slice(0, 10);
                
                // Save back to localStorage
                localStorage.setItem('trackingHistory', JSON.stringify(history));
                
                // Update the history table
                loadTrackingHistory();
            }
            
            function loadTrackingHistory() {
                const history = JSON.parse(localStorage.getItem('trackingHistory') || '[]');
                
                // Clear the table
                historyTableBody.innerHTML = '';
                
                if (history.length === 0) {
                    historyTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center">No tracking history yet</td>
                        </tr>
                    `;
                    return;
                }
                
                // Add each history item to the table
                history.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const formattedDate = new Date(item.date).toLocaleString();
                    
                    row.innerHTML = `
                        <td>${getTrackingTypeLabel(item.type)}</td>
                        <td>${item.number}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary track-again" 
                                data-type="${item.type}" 
                                data-number="${item.number}">
                                Track Again
                            </button>
                        </td>
                    `;
                    
                    historyTableBody.appendChild(row);
                });
                
                // Add event listeners to "Track Again" buttons
                document.querySelectorAll('.track-again').forEach(button => {
                    button.addEventListener('click', function() {
                        const type = this.getAttribute('data-type');
                        const number = this.getAttribute('data-number');
                        
                        // Set the form values
                        document.getElementById('trackingType').value = type;
                        document.getElementById('trackingNumber').value = number;
                        
                        // Submit the form
                        trackingForm.dispatchEvent(new Event('submit'));
                    });
                });
            }
            
            // Function to simulate API response for demonstration
            function simulateApiCall(trackingType, trackingNumber) {
                return new Promise((resolve, reject) => {
                    // Simulate API delay
                    setTimeout(() => {
                        // For demo purposes, reject if tracking number is "ERROR"
                        if (trackingNumber.toUpperCase() === "ERROR") {
                            reject(new Error("API Error: Invalid tracking number"));
                            return;
                        }
                        
                        // Create sample data based on tracking type
                        const events = [];
                        
                        // Generate random events
                        const eventTypes = ['SHIPMENT', 'TRANSPORT', 'EQUIPMENT'];
                        const locations = ['USNYC', 'DEHAM', 'NLRTM', 'SGSIN', 'CNSHA'];
                        const vessels = ['HOUSTON EXPRESS', 'ANTWERP EXPRESS', 'SINGAPORE EXPRESS'];
                        const voyages = ['2103S', '2104N', '2105S', '2106N'];
                        
                        // Current date for event timestamps
                        const now = new Date();
                        
                        // Generate 3-8 random events
                        const numEvents = 3 + Math.floor(Math.random() * 6);
                        
                        for (let i = 0; i < numEvents; i++) {
                            // Event date is now minus random days (0-30)
                            const eventDate = new Date(now);
                            eventDate.setDate(eventDate.getDate() - Math.floor(Math.random() * 30));
                            
                            // Random event type
                            const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                            
                            // Create base event
                            const event = {
                                eventType: eventType,
                                eventDateTime: eventDate.toISOString(),
                                eventCreatedDateTime: eventDate.toISOString(),
                                eventClassifierCode: 'ACT'
                            };
                            
                            // Add type-specific fields
                            if (eventType === 'TRANSPORT') {
                                event.transportEventTypeCode = Math.random() > 0.5 ? 'ARRI' : 'DEPA';
                                event.transportCall = {
                                    transportCallID: generateRandomId(),
                                    UNLocationCode: locations[Math.floor(Math.random() * locations.length)],
                                    facilityTypeCode: 'POTE',
                                    modeOfTransport: 'VESSEL',
                                    vessel: {
                                        vesselIMONumber: '9321483',
                                        vesselName: vessels[Math.floor(Math.random() * vessels.length)]
                                    },
                                    exportVoyageNumber: voyages[Math.floor(Math.random() * voyages.length)]
                                };
                            } else if (eventType === 'EQUIPMENT') {
                                event.equipmentEventTypeCode = ['LOAD', 'DISC', 'GTIN', 'GTOT'][Math.floor(Math.random() * 4)];
                                event.equipmentReference = trackingType === 'equipmentReference' ? trackingNumber : 'APZU4812090';
                                event.emptyIndicatorCode = Math.random() > 0.5 ? 'EMPTY' : 'LADEN';
                                event.eventLocation = {
                                    UNLocationCode: locations[Math.floor(Math.random() * locations.length)],
                                    locationName: 'Terminal ' + Math.floor(Math.random() * 10)
                                };
                            } else if (eventType === 'SHIPMENT') {
                                event.shipmentEventTypeCode = Math.random() > 0.5 ? 'ISSU' : 'CONF';
                                event.documentTypeCode = Math.random() > 0.5 ? 'BKG' : 'TRD';
                                event.documentID = trackingType === 'transportDocumentReference' ? 
                                    trackingNumber : 'HLCUGDN' + Math.floor(Math.random() * 10000000);
                            }
                            
                            events.push(event);
                        }
                        
                        // Sort by event date
                        events.sort((a, b) => new Date(b.eventDateTime) - new Date(a.eventDateTime));
                        
                        resolve(events);
                    }, 1500); // Simulate network delay
                });
            }
            
            function generateRandomId() {
                return 'xxxx-xxxx-xxxx-xxxx'.replace(/x/g, () => {
                    return Math.floor(Math.random() * 16).toString(16);
                });
            }
        });
    </script>
</body>
</html>