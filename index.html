<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        .app-container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 25%;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        .main-content {
            width: 75%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }
        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .form-container {
            margin-bottom: 30px;
        }
        .loading {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .api-error {
            display: none;
            margin-top: 20px;
        }
        .tracking-history {
            margin-top: 25px;
        }
        .results-table-container {
            margin-top: 20px;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80%;
            color: #6c757d;
            text-align: center;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .badge-container {
            margin-top: 15px;
        }
        .shipment-badge {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .shipment-badge:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar for input -->
        <div class="sidebar">
            <div class="header">
                <h3>Shipment Tracker</h3>
                <p class="text-muted">Track your shipments with ease</p>
            </div>

            <div class="form-container">
                <form id="trackingForm">
                    <div class="mb-3">
                        <label for="trackingType" class="form-label">Select tracking type:</label>
                        <select class="form-select" id="trackingType" required>
                            <option value="transportDocumentReference">Transport Document</option>
                            <option value="carrierBookingReference">Booking Reference</option>
                            <option value="equipmentReference">Container Number</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trackingNumber" class="form-label">Tracking Number:</label>
                        <input type="text" class="form-control" id="trackingNumber" placeholder="Enter tracking number" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Shipment</button>
                </form>
            </div>

            <div class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching shipment information...</p>
            </div>

            <div class="api-error alert alert-danger">
                <h5>Error Tracking Shipment</h5>
                <p id="errorMessage"></p>
            </div>

            <div class="badge-container">
                <h5>Active Shipments</h5>
                <div id="shipmentBadges">
                    <!-- Shipment badges will be added here -->
                    <div class="text-muted mt-2" id="noBadgesMessage">No shipments added yet</div>
                </div>
            </div>

            <div class="mt-4">
                <button id="clearAllBtn" class="btn btn-outline-danger btn-sm" disabled>Clear All</button>
            </div>
        </div>

        <!-- Main content area for results table -->
        <div class="main-content">
            <div id="emptyState" class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16">
                    <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                </svg>
                <h4 class="mt-3">No Shipments Added</h4>
                <p>Add a shipment in the sidebar to start tracking</p>
            </div>

            <div class="results-table-container" id="resultsContainer" style="display:none;">
                <h3>Shipment Events</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="eventsTable">
                        <thead>
                            <tr>
                                <th>Tracking Number</th>
                                <th>Event Type</th>
                                <th>Event Date</th>
                                <th>Location</th>
                                <th>Vessel/Voyage</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTableBody">
                            <!-- Event rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const trackingForm = document.getElementById('trackingForm');
            const eventsTableBody = document.getElementById('eventsTableBody');
            const loadingIndicator = document.querySelector('.loading');
            const apiError = document.querySelector('.api-error');
            const errorMessage = document.getElementById('errorMessage');
            const emptyState = document.getElementById('emptyState');
            const resultsContainer = document.getElementById('resultsContainer');
            const shipmentBadges = document.getElementById('shipmentBadges');
            const noBadgesMessage = document.getElementById('noBadgesMessage');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            // Track added shipments
            const addedShipments = new Set();
            
            // Initialize
            updateShipmentBadges();
            
            trackingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const trackingType = document.getElementById('trackingType').value;
                const trackingNumber = document.getElementById('trackingNumber').value.trim();
                
                if (!trackingNumber) {
                    alert('Please enter a tracking number');
                    return;
                }
                
                // Generate unique ID for this shipment
                const shipmentId = `${trackingType}-${trackingNumber}`;
                
                // Check if already added
                if (addedShipments.has(shipmentId)) {
                    alert(`This shipment (${getTrackingTypeLabel(trackingType)}: ${trackingNumber}) is already being tracked.`);
                    return;
                }
                
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                // Hide any previous errors
                apiError.style.display = 'none';
                
                // Add to tracking list immediately to prevent duplicate adds during loading
                addedShipments.add(shipmentId);
                updateShipmentBadges();
                
                // Call the tracking API
                trackShipment(trackingType, trackingNumber, shipmentId);
                
                // Clear the input field
                document.getElementById('trackingNumber').value = '';
            });
            
            clearAllBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all shipments?')) {
                    addedShipments.clear();
                    eventsTableBody.innerHTML = '';
                    updateShipmentBadges();
                    emptyState.style.display = 'flex';
                    resultsContainer.style.display = 'none';
                }
            });
            
            function trackShipment(trackingType, trackingNumber, shipmentId) {
                // In a real implementation, you would need to use your API credentials
                const clientId = 'YOUR_CLIENT_ID';  // Replace with your actual client ID
                const clientSecret = 'YOUR_CLIENT_SECRET';  // Replace with your actual client secret
                
                // Base URL for the API
                const baseUrl = 'https://api.hlag.com/hlag/external/v2/events';
                
                // Create API URL with the tracking parameters
                const apiUrl = `${baseUrl}?${trackingType}=${encodeURIComponent(trackingNumber)}`;
                
                // For demonstration purposes, we'll simulate an API response
                // In a real implementation, you would use fetch() to call the API
                simulateApiCall(trackingType, trackingNumber)
                    .then(data => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        // Add results to the table
                        addResultsToTable(data, trackingType, trackingNumber);
                        
                        // Hide empty state and show results
                        emptyState.style.display = 'none';
                        resultsContainer.style.display = 'block';
                    })
                    .catch(error => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        // Remove from tracking list since it failed
                        addedShipments.delete(shipmentId);
                        updateShipmentBadges();
                        
                        // Show error message
                        errorMessage.textContent = error.message || 'Error fetching shipment data. Please try again.';
                        apiError.style.display = 'block';
                    });
                
                // Commented out real API call - would replace the simulateApiCall above
                /*
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'X-IBM-Client-Id': clientId,
                        'X-IBM-Client-Secret': clientSecret,
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Add results to the table
                    addResultsToTable(data, trackingType, trackingNumber);
                    
                    // Hide empty state and show results
                    emptyState.style.display = 'none';
                    resultsContainer.style.display = 'block';
                })
                .catch(error => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Remove from tracking list since it failed
                    addedShipments.delete(shipmentId);
                    updateShipmentBadges();
                    
                    // Show error message
                    errorMessage.textContent = error.message || 'Error fetching shipment data. Please try again.';
                    apiError.style.display = 'block';
                });
                */
            }
            
            function addResultsToTable(data, trackingType, trackingNumber) {
                if (data.length === 0) {
                    // Add a row indicating no events for this shipment
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td colspan="6" class="text-center">No events found for this shipment</td>
                    `;
                    eventsTableBody.appendChild(row);
                    return;
                }
                
                // Sort events by date (newest first)
                data.sort((a, b) => new Date(b.eventDateTime) - new Date(a.eventDateTime));
                
                // Add each event to the table
                data.forEach(event => {
                    const eventType = event.eventType;
                    const eventDate = formatDate(event.eventDateTime);
                    
                    let location = 'N/A';
                    let vesselVoyage = 'N/A';
                    let status = 'N/A';
                    let details = '';
                    
                    if (eventType === 'TRANSPORT') {
                        location = event.transportCall?.UNLocationCode || 'N/A';
                        status = event.transportEventTypeCode || 'N/A';
                        
                        if (event.transportCall?.vessel) {
                            vesselVoyage = `${event.transportCall.vessel.vesselName || 'Unknown'} / ${event.transportCall.exportVoyageNumber || 'N/A'}`;
                        }
                        
                        details = `Mode: ${event.transportCall?.modeOfTransport || 'N/A'}`;
                    } else if (eventType === 'EQUIPMENT') {
                        location = event.eventLocation?.UNLocationCode || 'N/A';
                        status = event.equipmentEventTypeCode || 'N/A';
                        details = `Empty: ${event.emptyIndicatorCode || 'N/A'}, Equipment: ${event.equipmentReference || 'N/A'}`;
                    } else if (eventType === 'SHIPMENT') {
                        status = event.shipmentEventTypeCode || 'N/A';
                        details = `Document: ${event.documentTypeCode || 'N/A'}, ID: ${event.documentID || 'N/A'}`;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td>${eventType}</td>
                        <td>${eventDate}</td>
                        <td>${location}</td>
                        <td>${vesselVoyage}</td>
                        <td><span class="badge bg-primary">${status}</span></td>
                        <td>${details}</td>
                    `;
                    
                    eventsTableBody.appendChild(row);
                });
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString();
            }
            
            function getTrackingTypeLabel(trackingType) {
                switch(trackingType) {
                    case 'transportDocumentReference':
                        return 'Transport Document';
                    case 'carrierBookingReference':
                        return 'Booking Reference';
                    case 'equipmentReference':
                        return 'Container';
                    default:
                        return trackingType;
                }
            }
            
            function getTrackingTypeShortLabel(trackingType) {
                switch(trackingType) {
                    case 'transportDocumentReference':
                        return 'TD';
                    case 'carrierBookingReference':
                        return 'BK';
                    case 'equipmentReference':
                        return 'CN';
                    default:
                        return 'TN';
                }
            }
            
            function updateShipmentBadges() {
                // Clear current badges
                shipmentBadges.innerHTML = '';
                
                if (addedShipments.size === 0) {
                    shipmentBadges.appendChild(noBadgesMessage);
                    clearAllBtn.disabled = true;
                    return;
                }
                
                clearAllBtn.disabled = false;
                
                // Add a badge for each shipment
                addedShipments.forEach(shipmentId => {
                    const parts = shipmentId.split('-');
                    const type = parts[0];
                    const number = parts.slice(1).join('-'); // In case the tracking number itself contains dashes
                    
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-secondary shipment-badge';
                    badge.innerHTML = `${getTrackingTypeShortLabel(type)}: ${number} <span class="badge bg-danger ms-1 remove-badge" data-id="${shipmentId}">&times;</span>`;
                    shipmentBadges.appendChild(badge);
                    
                    // Add click handler for the remove button
                    badge.querySelector('.remove-badge').addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.getAttribute('data-id');
                        removeShipment(id);
                    });
                });
            }
            
            function removeShipment(shipmentId) {
                // Remove from tracking list
                addedShipments.delete(shipmentId);
                
                // Parse the ID to get type and number
                const parts = shipmentId.split('-');
                const trackingNumber = parts.slice(1).join('-');
                
                // Remove rows from table
                const rows = eventsTableBody.querySelectorAll('tr');
                for (let i = rows.length - 1; i >= 0; i--) {
                    if (rows[i].cells[0].textContent === trackingNumber) {
                        rows[i].remove();
                    }
                }
                
                // Update badges
                updateShipmentBadges();
                
                // Show empty state if no shipments left
                if (addedShipments.size === 0) {
                    emptyState.style.display = 'flex';
                    resultsContainer.style.display = 'none';
                }
            }
            
            // Function to simulate API response for demonstration
            function simulateApiCall(trackingType, trackingNumber) {
                return new Promise((resolve, reject) => {
                    // Simulate API delay
                    setTimeout(() => {
                        // For demo purposes, reject if tracking number is "ERROR"
                        if (trackingNumber.toUpperCase() === "ERROR") {
                            reject(new Error("API Error: Invalid tracking number"));
                            return;
                        }
                        
                        // Create sample data based on tracking type
                        const events = [];
                        
                        // Generate random events
                        const eventTypes = ['SHIPMENT', 'TRANSPORT', 'EQUIPMENT'];
                        const locations = ['USNYC', 'DEHAM', 'NLRTM', 'SGSIN', 'CNSHA'];
                        const vessels = ['HOUSTON EXPRESS', 'ANTWERP EXPRESS', 'SINGAPORE EXPRESS'];
                        const voyages = ['2103S', '2104N', '2105S', '2106N'];
                        
                        // Current date for event timestamps
                        const now = new Date();
                        
                        // Generate 3-8 random events
                        const numEvents = 3 + Math.floor(Math.random() * 6);
                        
                        for (let i = 0; i < numEvents; i++) {
                            // Event date is now minus random days (0-30)
                            const eventDate = new Date(now);
                            eventDate.setDate(eventDate.getDate() - Math.floor(Math.random() * 30));
                            
                            // Random event type
                            const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                            
                            // Create base event
                            const event = {
                                eventType: eventType,
                                eventDateTime: eventDate.toISOString(),
                                eventCreatedDateTime: eventDate.toISOString(),
                                eventClassifierCode: 'ACT'
                            };
                            
                            // Add type-specific fields
                            if (eventType === 'TRANSPORT') {
                                event.transportEventTypeCode = Math.random() > 0.5 ? 'ARRI' : 'DEPA';
                                event.transportCall = {
                                    transportCallID: generateRandomId(),
                                    UNLocationCode: locations[Math.floor(Math.random() * locations.length)],
                                    facilityTypeCode: 'POTE',
                                    modeOfTransport: 'VESSEL',
                                    vessel: {
                                        vesselIMONumber: '9321483',
                                        vesselName: vessels[Math.floor(Math.random() * vessels.length)]
                                    },
                                    exportVoyageNumber: voyages[Math.floor(Math.random() * voyages.length)]
                                };
                            } else if (eventType === 'EQUIPMENT') {
                                event.equipmentEventTypeCode = ['LOAD', 'DISC', 'GTIN', 'GTOT'][Math.floor(Math.random() * 4)];
                                event.equipmentReference = trackingType === 'equipmentReference' ? trackingNumber : 'APZU4812090';
                                event.emptyIndicatorCode = Math.random() > 0.5 ? 'EMPTY' : 'LADEN';
                                event.eventLocation = {
                                    UNLocationCode: locations[Math.floor(Math.random() * locations.length)],
                                    locationName: 'Terminal ' + Math.floor(Math.random() * 10)
                                };
                            } else if (eventType === 'SHIPMENT') {
                                event.shipmentEventTypeCode = Math.random() > 0.5 ? 'ISSU' : 'CONF';
                                event.documentTypeCode = Math.random() > 0.5 ? 'BKG' : 'TRD';
                                event.documentID = trackingType === 'transportDocumentReference' ? 
                                    trackingNumber : 'HLCUGDN' + Math.floor(Math.random() * 10000000);
                            }
                            
                            events.push(event);
                        }
                        
                        // Sort by event date
                        events.sort((a, b) => new Date(b.eventDateTime) - new Date(a.eventDateTime));
                        
                        resolve(events);
                    }, 1500); // Simulate network delay
                });
            }
            
            function generateRandomId() {
                return 'xxxx-xxxx-xxxx-xxxx'.replace(/x/g, () => {
                    return Math.floor(Math.random() * 16).toString(16);
                });
            }
        });
    </script>
</body>
</html>