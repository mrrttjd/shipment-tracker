<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        .app-container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 25%;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        .main-content {
            width: 75%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }
        .header {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .form-container {
            margin-bottom: 30px;
        }
        .loading {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .api-error {
            display: none;
            margin-top: 20px;
        }
        .badge-container {
            margin-top: 25px;
        }
        .results-table-container {
            margin-top: 20px;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80%;
            color: #6c757d;
            text-align: center;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .badge-container {
            margin-top: 15px;
        }
        .shipment-badge {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .shipment-badge:hover {
            opacity: 0.9;
        }
        .tab-content {
            padding-top: 20px;
        }
        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            margin-bottom: -1px;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-tabs .nav-link:hover,
        .nav-tabs .nav-link:focus {
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .tab-pane {
            padding: 20px 0;
        }
        .badge-counter {
            font-size: 0.8em;
            vertical-align: top;
        }
        .quick-add-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #dee2e6;
        }
        .sample-btn {
            margin-bottom: 5px;
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .pulse-icon {
            animation: pulse 2s infinite;
            color: #28a745;
        }
        .actions-bar {
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">How to Use</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Tracking Shipments</h6>
                    <ol>
                        <li>Select tracking type (Transport Document, Booking Reference, Container)</li>
                        <li>Enter tracking number or click a sample button</li>
                        <li>View results in the tabs on the right</li>
                    </ol>
                    
                    <h6>Demo Features</h6>
                    <ul>
                        <li>Type "ERROR" to see error handling</li>
                        <li>Export to CSV from the ALL tab</li>
                        <li>LIVE tab shows most recent events</li>
                    </ul>
                    
                    <div class="alert alert-info small">
                        This is a demo application. In a real implementation, you would need API credentials.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <!-- Sidebar for input -->
        <div class="sidebar">
            <div class="header">
                <h3>Shipment Tracker</h3>
                <p class="text-muted">Track your shipments with ease</p>
                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-circle me-1"></i> How to Use
                </button>
            </div>

            <div class="form-container">
                <form id="trackingForm">
                    <div class="mb-3">
                        <label for="trackingType" class="form-label">Select tracking type:</label>
                        <select class="form-select" id="trackingType" required>
                            <option value="transportDocumentReference">Transport Document</option>
                            <option value="carrierBookingReference">Booking Reference</option>
                            <option value="equipmentReference">Container Number</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trackingNumber" class="form-label">Tracking Number:</label>
                        <input type="text" class="form-control" id="trackingNumber" placeholder="Enter tracking number" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Shipment</button>
                </form>
                
                <!-- Quick Add Sample Shipments -->
                <div class="quick-add-container">
                    <h6>Quick Add Sample Shipments</h6>
                    <div class="d-flex flex-wrap">
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="transportDocumentReference" data-number="HLCUEUR123456789">HLCUEUR123456789</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="transportDocumentReference" data-number="MAEU9876543210">MAEU9876543210</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="carrierBookingReference" data-number="BKGNY54321">BKGNY54321</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="equipmentReference" data-number="MAEU1234567">MAEU1234567</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="equipmentReference" data-number="APZU4812090">APZU4812090</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="transportDocumentReference" data-number="HLXU4567891234">HLXU4567891234</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="carrierBookingReference" data-number="BKGLAX12345">BKGLAX12345</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="equipmentReference" data-number="MSCU9876543">MSCU9876543</button>
                        <button class="btn btn-sm btn-outline-secondary sample-btn" data-type="carrierBookingReference" data-number="BKGSEA98765">BKGSEA98765</button>
                    </div>
                </div>
            </div>

            <div class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching shipment information...</p>
            </div>

            <div class="api-error alert alert-danger">
                <h5>Error Tracking Shipment</h5>
                <p id="errorMessage"></p>
            </div>

            <div class="badge-container">
                <h5>Active Shipments</h5>
                <div id="shipmentBadges">
                    <!-- Shipment badges will be added here -->
                    <div class="text-muted mt-2" id="noBadgesMessage">No shipments added yet</div>
                </div>
            </div>

            <div class="mt-4">
                <button id="clearAllBtn" class="btn btn-outline-danger btn-sm" disabled>Clear All</button>
            </div>
        </div>

        <!-- Main content area for results table -->
        <div class="main-content">
            <div id="emptyState" class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16">
                    <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                </svg>
                <h4 class="mt-3">No Shipments Added</h4>
                <p>Add a shipment in the sidebar to start tracking</p>
                <p class="mt-3"><button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#helpModal">How to Use This Demo</button></p>
            </div>

            <div class="results-table-container" id="resultsContainer" style="display:none;">
                <h3>Shipment Events</h3>
                
                <div class="actions-bar" id="actionsBar">
                    <button id="exportCsvBtn" class="btn btn-sm btn-outline-success me-2">
                        <i class="bi bi-file-earmark-excel me-1"></i> Export to CSV
                    </button>
                </div>
                
                <!-- Tabs for different shipment types -->
                <ul class="nav nav-tabs" id="shipmentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#live-pane" type="button" role="tab" aria-controls="live-pane" aria-selected="false">
                            <i class="bi bi-broadcast pulse-icon me-1"></i> Live <span class="badge bg-secondary badge-counter" id="live-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-pane" type="button" role="tab" aria-controls="all-pane" aria-selected="true">
                            All <span class="badge bg-secondary badge-counter" id="all-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transport-tab" data-bs-toggle="tab" data-bs-target="#transport-pane" type="button" role="tab" aria-controls="transport-pane" aria-selected="false">
                            Transport Documents <span class="badge bg-secondary badge-counter" id="transport-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking-pane" type="button" role="tab" aria-controls="booking-pane" aria-selected="false">
                            Booking References <span class="badge bg-secondary badge-counter" id="booking-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="container-tab" data-bs-toggle="tab" data-bs-target="#container-pane" type="button" role="tab" aria-controls="container-pane" aria-selected="false">
                            Containers <span class="badge bg-secondary badge-counter" id="container-count">0</span>
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="shipmentTabContent">
                    <!-- Live tab -->
                    <div class="tab-pane fade" id="live-pane" role="tabpanel" aria-labelledby="live-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="liveEventsTable">
                                <thead>
                                    <tr>
                                        <th>Tracking Number</th>
                                        <th>Type</th>
                                        <th>Event Type</th>
                                        <th>Event Date</th>
                                        <th>Location</th>
                                        <th>Vessel/Voyage</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="liveEventsTableBody">
                                    <!-- Latest event rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- All shipments tab -->
                    <div class="tab-pane fade show active" id="all-pane" role="tabpanel" aria-labelledby="all-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="allEventsTable">
                                <thead>
                                    <tr>
                                        <th>Tracking Number</th>
                                        <th>Type</th>
                                        <th>Event Type</th>
                                        <th>Event Date</th>
                                        <th>Location</th>
                                        <th>Vessel/Voyage</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="allEventsTableBody">
                                    <!-- Event rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Transport documents tab -->
                    <div class="tab-pane fade" id="transport-pane" role="tabpanel" aria-labelledby="transport-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="transportEventsTable">
                                <thead>
                                    <tr>
                                        <th>Document Number</th>
                                        <th>Event Type</th>
                                        <th>Event Date</th>
                                        <th>Location</th>
                                        <th>Vessel/Voyage</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="transportEventsTableBody">
                                    <!-- Event rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Booking references tab -->
                    <div class="tab-pane fade" id="booking-pane" role="tabpanel" aria-labelledby="booking-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="bookingEventsTable">
                                <thead>
                                    <tr>
                                        <th>Booking Reference</th>
                                        <th>Event Type</th>
                                        <th>Event Date</th>
                                        <th>Location</th>
                                        <th>Vessel/Voyage</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingEventsTableBody">
                                    <!-- Event rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Container numbers tab -->
                    <div class="tab-pane fade" id="container-pane" role="tabpanel" aria-labelledby="container-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="containerEventsTable">
                                <thead>
                                    <tr>
                                        <th>Container Number</th>
                                        <th>Event Type</th>
                                        <th>Event Date</th>
                                        <th>Location</th>
                                        <th>Vessel/Voyage</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="containerEventsTableBody">
                                    <!-- Event rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Bootstrap JS for tab functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const trackingForm = document.getElementById('trackingForm');
            const allEventsTableBody = document.getElementById('allEventsTableBody');
            const liveEventsTableBody = document.getElementById('liveEventsTableBody');
            const transportEventsTableBody = document.getElementById('transportEventsTableBody');
            const bookingEventsTableBody = document.getElementById('bookingEventsTableBody');
            const containerEventsTableBody = document.getElementById('containerEventsTableBody');
            const loadingIndicator = document.querySelector('.loading');
            const apiError = document.querySelector('.api-error');
            const errorMessage = document.getElementById('errorMessage');
            const emptyState = document.getElementById('emptyState');
            const resultsContainer = document.getElementById('resultsContainer');
            const shipmentBadges = document.getElementById('shipmentBadges');
            const noBadgesMessage = document.getElementById('noBadgesMessage');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const sampleButtons = document.querySelectorAll('.sample-btn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            
            // Counter elements
            const allCountBadge = document.getElementById('all-count');
            const liveCountBadge = document.getElementById('live-count');
            const transportCountBadge = document.getElementById('transport-count');
            const bookingCountBadge = document.getElementById('booking-count');
            const containerCountBadge = document.getElementById('container-count');
            
            // Track added shipments, counts and latest events
            const addedShipments = new Set();
            const latestEvents = new Map(); // To store latest event for each shipment
            let shipmentCounts = {
                transport: 0,
                booking: 0,
                container: 0,
                total: 0,
                live: 0
            };
            
            // Initialize
            updateShipmentBadges();
            updateCountBadges();
            
            // Show help modal on first load
            window.addEventListener('load', function() {
                // Show the help modal after a short delay
                setTimeout(() => {
                    const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
                    helpModal.show();
                }, 1000);
            });
            
            // Set up export CSV functionality
            exportCsvBtn.addEventListener('click', function() {
                exportTableToCSV('shipment_events.csv');
            });
            
            // Set up sample button handlers
            sampleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const trackingType = this.getAttribute('data-type');
                    const trackingNumber = this.getAttribute('data-number');
                    
                    // Set the form values
                    document.getElementById('trackingType').value = trackingType;
                    document.getElementById('trackingNumber').value = trackingNumber;
                    
                    // Submit the form programmatically
                    trackingForm.dispatchEvent(new Event('submit'));
                });
            });
            
            trackingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const trackingType = document.getElementById('trackingType').value;
                const trackingNumber = document.getElementById('trackingNumber').value.trim();
                
                if (!trackingNumber) {
                    alert('Please enter a tracking number');
                    return;
                }
                
                // Generate unique ID for this shipment
                const shipmentId = `${trackingType}-${trackingNumber}`;
                
                // Check if already added
                if (addedShipments.has(shipmentId)) {
                    alert(`This shipment (${getTrackingTypeLabel(trackingType)}: ${trackingNumber}) is already being tracked.`);
                    return;
                }
                
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                // Hide any previous errors
                apiError.style.display = 'none';
                
                // Add to tracking list immediately to prevent duplicate adds during loading
                addedShipments.add(shipmentId);
                updateShipmentBadges();
                
                // Call the tracking API
                trackShipment(trackingType, trackingNumber, shipmentId);
                
                // Clear the input field
                document.getElementById('trackingNumber').value = '';
            });
            
            clearAllBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all shipments?')) {
                    addedShipments.clear();
                    latestEvents.clear();
                    allEventsTableBody.innerHTML = '';
                    liveEventsTableBody.innerHTML = '';
                    transportEventsTableBody.innerHTML = '';
                    bookingEventsTableBody.innerHTML = '';
                    containerEventsTableBody.innerHTML = '';
                    
                    // Reset counts
                    shipmentCounts = {
                        transport: 0,
                        booking: 0,
                        container: 0,
                        total: 0,
                        live: 0
                    };
                    
                    updateShipmentBadges();
                    updateCountBadges();
                    emptyState.style.display = 'flex';
                    resultsContainer.style.display = 'none';
                }
            });
            
            function trackShipment(trackingType, trackingNumber, shipmentId) {
                // In a real implementation, you would need to use your API credentials
                const clientId = 'YOUR_CLIENT_ID';  // Replace with your actual client ID
                const clientSecret = 'YOUR_CLIENT_SECRET';  // Replace with your actual client secret
                
                // Base URL for the API
                const baseUrl = 'https://api.hlag.com/hlag/external/v2/events';
                
                // Create API URL with the tracking parameters
                const apiUrl = `${baseUrl}?${trackingType}=${encodeURIComponent(trackingNumber)}`;
                
                // For demonstration purposes, we'll simulate an API response
                // In a real implementation, you would use fetch() to call the API
                simulateApiCall(trackingType, trackingNumber)
                    .then(data => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        // Update the shipment count for the correct category
                        incrementShipmentCount(trackingType);
                        
                        // Add results to the tables
                        addResultsToTables(data, trackingType, trackingNumber);
                        
                        // Hide empty state and show results
                        emptyState.style.display = 'none';
                        resultsContainer.style.display = 'block';
                        
                        // Activate the appropriate tab based on the tracking type
                        activateTabForTrackingType(trackingType);
                    })
                    .catch(error => {
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                        
                        // Remove from tracking list since it failed
                        addedShipments.delete(shipmentId);
                        updateShipmentBadges();
                        
                        // Show error message
                        errorMessage.textContent = error.message || 'Error fetching shipment data. Please try again.';
                        apiError.style.display = 'block';
                    });
                
                // Commented out real API call - would replace the simulateApiCall above
                /*
                fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'X-IBM-Client-Id': clientId,
                        'X-IBM-Client-Secret': clientSecret,
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Update the shipment count for the correct category
                    incrementShipmentCount(trackingType);
                    
                    // Add results to the tables
                    addResultsToTables(data, trackingType, trackingNumber);
                    
                    // Hide empty state and show results
                    emptyState.style.display = 'none';
                    resultsContainer.style.display = 'block';
                    
                    // Activate the appropriate tab based on the tracking type
                    activateTabForTrackingType(trackingType);
                })
                .catch(error => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Remove from tracking list since it failed
                    addedShipments.delete(shipmentId);
                    updateShipmentBadges();
                    
                    // Show error message
                    errorMessage.textContent = error.message || 'Error fetching shipment data. Please try again.';
                    apiError.style.display = 'block';
                });
                */
            }
            
            function incrementShipmentCount(trackingType) {
                shipmentCounts.total++;
                shipmentCounts.live++;
                
                if (trackingType === 'transportDocumentReference') {
                    shipmentCounts.transport++;
                } else if (trackingType === 'carrierBookingReference') {
                    shipmentCounts.booking++;
                } else if (trackingType === 'equipmentReference') {
                    shipmentCounts.container++;
                }
                
                updateCountBadges();
            }
            
            function updateCountBadges() {
                allCountBadge.textContent = shipmentCounts.total;
                liveCountBadge.textContent = shipmentCounts.live;
                transportCountBadge.textContent = shipmentCounts.transport;
                bookingCountBadge.textContent = shipmentCounts.booking;
                containerCountBadge.textContent = shipmentCounts.container;
            }
            
            function activateTabForTrackingType(trackingType) {
                let tabId;
                
                if (trackingType === 'transportDocumentReference') {
                    tabId = 'transport-tab';
                } else if (trackingType === 'carrierBookingReference') {
                    tabId = 'booking-tab';
                } else if (trackingType === 'equipmentReference') {
                    tabId = 'container-tab';
                } else {
                    tabId = 'all-tab';
                }
                
                // Use Bootstrap's API to activate the tab
                const tabElement = document.getElementById(tabId);
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
            }
            
            function addResultsToTables(data, trackingType, trackingNumber) {
                if (data.length === 0) {
                    // Add a row indicating no events for this shipment to all relevant tables
                    const allRow = document.createElement('tr');
                    allRow.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td>${getTrackingTypeShortLabel(trackingType)}</td>
                        <td colspan="6" class="text-center">No events found for this shipment</td>
                    `;
                    allEventsTableBody.appendChild(allRow);
                    
                    // Add to the live table
                    const liveRow = allRow.cloneNode(true);
                    liveEventsTableBody.appendChild(liveRow);
                    
                    // Add to the type-specific table too
                    const typeRow = document.createElement('tr');
                    typeRow.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td colspan="6" class="text-center">No events found for this shipment</td>
                    `;
                    
                    if (trackingType === 'transportDocumentReference') {
                        transportEventsTableBody.appendChild(typeRow);
                    } else if (trackingType === 'carrierBookingReference') {
                        bookingEventsTableBody.appendChild(typeRow);
                    } else if (trackingType === 'equipmentReference') {
                        containerEventsTableBody.appendChild(typeRow);
                    }
                    
                    return;
                }
                
                // Sort events by date (newest first)
                data.sort((a, b) => new Date(b.eventDateTime) - new Date(a.eventDateTime));
                
                // Get latest event for live tab
                const latestEvent = data[0];
                
                // Create a key for this shipment
                const shipmentKey = `${trackingType}-${trackingNumber}`;
                
                // Store latest event for this shipment
                latestEvents.set(shipmentKey, {
                    trackingType, 
                    trackingNumber, 
                    event: latestEvent
                });
                
                // Refresh live tab with latest events for all shipments
                updateLiveTab();
                
                // Add each event to the tables
                data.forEach(event => {
                    const eventType = event.eventType;
                    const eventDate = formatDate(event.eventDateTime);
                    
                    let location = 'N/A';
                    let vesselVoyage = 'N/A';
                    let status = 'N/A';
                    let details = '';
                    
                    if (eventType === 'TRANSPORT') {
                        location = event.transportCall?.UNLocationCode || 'N/A';
                        status = event.transportEventTypeCode || 'N/A';
                        
                        if (event.transportCall?.vessel) {
                            vesselVoyage = `${event.transportCall.vessel.vesselName || 'Unknown'} / ${event.transportCall.exportVoyageNumber || 'N/A'}`;
                        }
                        
                        details = `Mode: ${event.transportCall?.modeOfTransport || 'N/A'}`;
                    } else if (eventType === 'EQUIPMENT') {
                        location = event.eventLocation?.UNLocationCode || 'N/A';
                        status = event.equipmentEventTypeCode || 'N/A';
                        details = `Empty: ${event.emptyIndicatorCode || 'N/A'}, Equipment: ${event.equipmentReference || 'N/A'}`;
                    } else if (eventType === 'SHIPMENT') {
                        status = event.shipmentEventTypeCode || 'N/A';
                        details = `Document: ${event.documentTypeCode || 'N/A'}, ID: ${event.documentID || 'N/A'}`;
                    }
                    
                    // Create row for the All tab
                    const allRow = document.createElement('tr');
                    allRow.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td>${getTrackingTypeShortLabel(trackingType)}</td>
                        <td>${eventType}</td>
                        <td>${eventDate}</td>
                        <td>${location}</td>
                        <td>${vesselVoyage}</td>
                        <td><span class="badge bg-primary">${status}</span></td>
                        <td>${details}</td>
                    `;
                    allEventsTableBody.appendChild(allRow);
                    
                    // Create row for the type-specific tab
                    const typeRow = document.createElement('tr');
                    typeRow.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td>${eventType}</td>
                        <td>${eventDate}</td>
                        <td>${location}</td>
                        <td>${vesselVoyage}</td>
                        <td><span class="badge bg-primary">${status}</span></td>
                        <td>${details}</td>
                    `;
                    
                    // Add to the appropriate type-specific table
                    if (trackingType === 'transportDocumentReference') {
                        transportEventsTableBody.appendChild(typeRow.cloneNode(true));
                    } else if (trackingType === 'carrierBookingReference') {
                        bookingEventsTableBody.appendChild(typeRow.cloneNode(true));
                    } else if (trackingType === 'equipmentReference') {
                        containerEventsTableBody.appendChild(typeRow.cloneNode(true));
                    }
                });
            }
            
            function updateLiveTab() {
                // Clear the live tab
                liveEventsTableBody.innerHTML = '';
                
                // Add each latest event to the live tab
                latestEvents.forEach(({trackingType, trackingNumber, event}) => {
                    const eventType = event.eventType;
                    const eventDate = formatDate(event.eventDateTime);
                    
                    let location = 'N/A';
                    let vesselVoyage = 'N/A';
                    let status = 'N/A';
                    let details = '';
                    
                    if (eventType === 'TRANSPORT') {
                        location = event.transportCall?.UNLocationCode || 'N/A';
                        status = event.transportEventTypeCode || 'N/A';
                        
                        if (event.transportCall?.vessel) {
                            vesselVoyage = `${event.transportCall.vessel.vesselName || 'Unknown'} / ${event.transportCall.exportVoyageNumber || 'N/A'}`;
                        }
                        
                        details = `Mode: ${event.transportCall?.modeOfTransport || 'N/A'}`;
                    } else if (eventType === 'EQUIPMENT') {
                        location = event.eventLocation?.UNLocationCode || 'N/A';
                        status = event.equipmentEventTypeCode || 'N/A';
                        details = `Empty: ${event.emptyIndicatorCode || 'N/A'}, Equipment: ${event.equipmentReference || 'N/A'}`;
                    } else if (eventType === 'SHIPMENT') {
                        status = event.shipmentEventTypeCode || 'N/A';
                        details = `Document: ${event.documentTypeCode || 'N/A'}, ID: ${event.documentID || 'N/A'}`;
                    }
                    
                    // Create row for the Live tab
                    const liveRow = document.createElement('tr');
                    liveRow.innerHTML = `
                        <td>${trackingNumber}</td>
                        <td>${getTrackingTypeShortLabel(trackingType)}</td>
                        <td>${eventType}</td>
                        <td>${eventDate}</td>
                        <td>${location}</td>
                        <td>${vesselVoyage}</td>
                        <td><span class="badge bg-primary">${status}</span></td>
                        <td>${details}</td>
                    `;
                    liveEventsTableBody.appendChild(liveRow);
                });
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString();
            }
            
            function getTrackingTypeLabel(trackingType) {
                switch(trackingType) {
                    case 'transportDocumentReference':
                        return 'Transport Document';
                    case 'carrierBookingReference':
                        return 'Booking Reference';
                    case 'equipmentReference':
                        return 'Container';
                    default:
                        return trackingType;
                }
            }
            
            function getTrackingTypeShortLabel(trackingType) {
                switch(trackingType) {
                    case 'transportDocumentReference':
                        return 'TD';
                    case 'carrierBookingReference':
                        return 'BK';
                    case 'equipmentReference':
                        return 'CN';
                    default:
                        return 'TN';
                }
            }
            
            function updateShipmentBadges() {
                // Clear current badges
                shipmentBadges.innerHTML = '';
                
                if (addedShipments.size === 0) {
                    shipmentBadges.appendChild(noBadgesMessage);
                    clearAllBtn.disabled = true;
                    return;
                }
                
                clearAllBtn.disabled = false;
                
                // Add a badge for each shipment
                addedShipments.forEach(shipmentId => {
                    const parts = shipmentId.split('-');
                    const type = parts[0];
                    const number = parts.slice(1).join('-'); // In case the tracking number itself contains dashes
                    
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-secondary shipment-badge';
                    badge.innerHTML = `${getTrackingTypeShortLabel(type)}: ${number} <span class="badge bg-danger ms-1 remove-badge" data-id="${shipmentId}">&times;</span>`;
                    shipmentBadges.appendChild(badge);
                    
                    // Add click handler for the remove button
                    badge.querySelector('.remove-badge').addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.getAttribute('data-id');
                        removeShipment(id);
                    });
                });
            }
            
            function removeShipment(shipmentId) {
                // Remove from tracking list
                addedShipments.delete(shipmentId);
                
                // Remove from latest events
                latestEvents.delete(shipmentId);
                
                // Parse the ID to get type and number
                const parts = shipmentId.split('-');
                const trackingType = parts[0];
                const trackingNumber = parts.slice(1).join('-');
                
                // Remove rows from all tables
                removeRowsFromTable(allEventsTableBody, trackingNumber);
                removeRowsFromTable(liveEventsTableBody, trackingNumber);
                
                if (trackingType === 'transportDocumentReference') {
                    removeRowsFromTable(transportEventsTableBody, trackingNumber);
                    shipmentCounts.transport--;
                } else if (trackingType === 'carrierBookingReference') {
                    removeRowsFromTable(bookingEventsTableBody, trackingNumber);
                    shipmentCounts.booking--;
                } else if (trackingType === 'equipmentReference') {
                    removeRowsFromTable(containerEventsTableBody, trackingNumber);
                    shipmentCounts.container--;
                }
                
                shipmentCounts.total--;
                shipmentCounts.live--;
                
                // Update badges and counts
                updateShipmentBadges();
                updateCountBadges();
                
                // Show empty state if no shipments left
                if (addedShipments.size === 0) {
                    emptyState.style.display = 'flex';
                    resultsContainer.style.display = 'none';
                }
            }
            
            function removeRowsFromTable(tableBody, trackingNumber) {
                const rows = tableBody.querySelectorAll('tr');
                for (let i = rows.length - 1; i >= 0; i--) {
                    if (rows[i].cells[0].textContent === trackingNumber) {
                        rows[i].remove();
                    }
                }
            }
            
            // Function to export table data to CSV
            function exportTableToCSV(filename) {
                const table = document.getElementById('allEventsTable');
                let csv = [];
                const rows = table.querySelectorAll('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = [], cols = rows[i].querySelectorAll('td, th');
                    
                    for (let j = 0; j < cols.length; j++) {
                        // Get cell text content and clean it
                        let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
                        
                        // Escape commas and quotes
                        data = data.replace(/"/g, '""');
                        
                        // If the cell contains a comma, enclose it in quotes
                        if (data.includes(',')) {
                            data = `"${data}"`;
                        }
                        
                        row.push(data);
                    }
                    
                    csv.push(row.join(','));
                }
                
                // Create CSV file
                const csvFile = new Blob([csv.join('\n')], {type: 'text/csv'});
                
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.download = filename;
                downloadLink.href = window.URL.createObjectURL(csvFile);
                downloadLink.style.display = 'none';
                
                // Add to DOM and trigger download
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }
            
            // Function to simulate API response for demonstration
            function simulateApiCall(trackingType, trackingNumber) {
                return new Promise((resolve, reject) => {
                    // Simulate API delay
                    setTimeout(() => {
                        // For demo purposes, reject if tracking number is "ERROR"
                        if (trackingNumber.toUpperCase() === "ERROR") {
                            reject(new Error("API Error: Invalid tracking number"));
                            return;
                        }
                        
                        // Create sample data based on tracking type
                        const events = [];
                        
                        // Generate random events
                        const eventTypes = ['SHIPMENT', 'TRANSPORT', 'EQUIPMENT'];
                        const locations = ['USNYC', 'DEHAM', 'NLRTM', 'SGSIN', 'CNSHA', 'AEDXB', 'INMAA', 'BRRIG', 'JPYOK', 'MXZLO'];
                        const vessels = [
                            'HOUSTON EXPRESS', 'ANTWERP EXPRESS', 'SINGAPORE EXPRESS', 
                            'MSC MAYA', 'MSC LONDON', 'CMA CGM BRAZIL', 'EVER GIVEN', 
                            'MADRID MAERSK', 'OOCL HONG KONG', 'MOL TRIUMPH'
                        ];
                        const voyages = ['2103S', '2104N', '2105S', '2106N', 'FE12', 'WB15', 'TP18', 'AS22'];
                        const transportEventCodes = ['ARRI', 'DEPA', 'LOAD', 'DISC', 'GTOT', 'GTIN'];
                        const equipmentEventCodes = ['LOAD', 'DISC', 'GTIN', 'GTOT', 'STRT', 'CMPL'];
                        const shipmentEventCodes = ['ISSU', 'CONF', 'APPR', 'SUBM', 'RECE'];
                        const documentTypeCodes = ['BKG', 'TRD', 'SHI', 'ARR', 'VGM', 'CUS'];
                        const modeOfTransport = ['VESSEL', 'RAIL', 'TRUCK', 'BARGE'];
                        
                        // Current date for event timestamps
                        const now = new Date();
                        
                        // Generate 5-12 random events for a more realistic simulation
                        const numEvents = 5 + Math.floor(Math.random() * 8);
                        
                        for (let i = 0; i < numEvents; i++) {
                            // Event date is now minus random days (0-45 for longer shipment history)
                            const eventDate = new Date(now);
                            eventDate.setDate(eventDate.getDate() - Math.floor(Math.random() * 45));
                            
                            // Random event type weighted more towards the type of tracking
                            let eventType;
                            if (trackingType === 'transportDocumentReference') {
                                // More likely to be SHIPMENT or TRANSPORT events
                                eventType = Math.random() < 0.7 ? 
                                    (Math.random() < 0.6 ? 'SHIPMENT' : 'TRANSPORT') : 
                                    'EQUIPMENT';
                            } else if (trackingType === 'carrierBookingReference') {
                                // More likely to be SHIPMENT events
                                eventType = Math.random() < 0.6 ? 
                                    'SHIPMENT' : 
                                    (Math.random() < 0.5 ? 'TRANSPORT' : 'EQUIPMENT');
                            } else {
                                // For container tracking, more likely to be EQUIPMENT events
                                eventType = Math.random() < 0.7 ? 
                                    'EQUIPMENT' : 
                                    (Math.random() < 0.5 ? 'TRANSPORT' : 'SHIPMENT');
                            }
                            
                            // Create base event
                            const event = {
                                eventType: eventType,
                                eventDateTime: eventDate.toISOString(),
                                eventCreatedDateTime: new Date(eventDate.getTime() + Math.random() * 86400000).toISOString(), // Random time within 24h after event
                                eventClassifierCode: Math.random() > 0.1 ? 'ACT' : 'PLN' // Mostly actual events, some planned
                            };
                            
                            // Add type-specific fields
                            if (eventType === 'TRANSPORT') {
                                event.transportEventTypeCode = transportEventCodes[Math.floor(Math.random() * transportEventCodes.length)];
                                event.transportCall = {
                                    transportCallID: generateRandomId(),
                                    UNLocationCode: locations[Math.floor(Math.random() * locations.length)],
                                    facilityTypeCode: Math.random() > 0.7 ? 'POTE' : 'RAMP',
                                    modeOfTransport: modeOfTransport[Math.floor(Math.random() * modeOfTransport.length)],
                                    vessel: {
                                        vesselIMONumber: '9' + Math.floor(100000 + Math.random() * 900000),
                                        vesselName: vessels[Math.floor(Math.random() * vessels.length)]
                                    },
                                    exportVoyageNumber: voyages[Math.floor(Math.random() * voyages.length)]
                                };
                            } else if (eventType === 'EQUIPMENT') {
                                event.equipmentEventTypeCode = equipmentEventCodes[Math.floor(Math.random() * equipmentEventCodes.length)];
                                event.equipmentReference = trackingType === 'equipmentReference' ? 
                                    trackingNumber : 
                                    ['APZU', 'MSCU', 'CMAU', 'OOLU', 'MAEU'][Math.floor(Math.random() * 5)] + 
                                    Math.floor(1000000 + Math.random() * 9000000);
                                event.emptyIndicatorCode = Math.random() > 0.5 ? 'EMPTY' : 'LADEN';
                                event.eventLocation = {
                                    UNLocationCode: locations[Math.floor(Math.random() * locations.length)],
                                    locationName: 'Terminal ' + Math.floor(Math.random() * 10)
                                };
                                event.equipmentReference = event.equipmentReference.substring(0, 11); // Ensure valid length
                            } else if (eventType === 'SHIPMENT') {
                                event.shipmentEventTypeCode = shipmentEventCodes[Math.floor(Math.random() * shipmentEventCodes.length)];
                                event.documentTypeCode = documentTypeCodes[Math.floor(Math.random() * documentTypeCodes.length)];
                                event.documentID = trackingType === 'transportDocumentReference' ? 
                                    trackingNumber : 
                                    (trackingType === 'carrierBookingReference' ? 
                                        trackingNumber : 
                                        'HLCUGDN' + Math.floor(Math.random() * 10000000));
                            }
                            
                            events.push(event);
                        }
                        
                        // Sort by event date
                        events.sort((a, b) => new Date(b.eventDateTime) - new Date(a.eventDateTime));
                        
                        resolve(events);
                    }, 1000 + Math.random() * 1000); // Simulate variable network delay
                });
            }
            
            function generateRandomId() {
                return 'xxxx-xxxx-xxxx-xxxx'.replace(/x/g, () => {
                    return Math.floor(Math.random() * 16).toString(16);
                });
            }
        });
    </script>
</body>
</html>